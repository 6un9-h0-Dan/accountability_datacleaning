---
title: "Nebraska Expenditures"
author: "Kiernan Nicholls"
date: "`r Sys.time()`"
output:
  github_document: 
    df_print: tibble
    toc: true
    toc_dept: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, purl=FALSE}
library(knitr)
opts_chunk$set(
  eval = TRUE,
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  comment = "#>",
  fig.path = "../plots/",
  fig.width = 10,
  dpi = 300
)
options(width = 99)
```

## Project

The Accountability Project is an effort to cut across data silos and give journalists, policy
professionals, activists, and the public at large a simple way to search across huge volumes of
public data about people and organizations.

Our goal is to standardizing public data on a few key fields by thinking of each dataset row as a
transaction. For each transaction there should be (at least) 3 variables:

1. All **parties** to a transaction
2. The **date** of the transaction
3. The **amount** of money involved

## Objectives

This document describes the process used to complete the following objectives:

1. How many records are in the database?
1. Check for duplicates
1. Check ranges
1. Is there anything blank or missing?
1. Check for consistency issues
1. Create a five-digit ZIP Code called `ZIP5`
1. Create a `YEAR` field from the transaction date
1. Make sure there is data on both parties to a transaction

## Packages

The following packages are needed to collect, manipulate, visualize, analyze, and communicate
these results. The `pacman` package will facilitate their installation and attachment.

The IRW's `campfin` package will also have to be installed from GitHub. This package contains
functions custom made to help facilitate the processing of campaign finance data.

```{r load_packages, message=FALSE, dfrning=FALSE, error=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load_current_gh("kiernann/campfin")
pacman::p_load(
  stringdist, # levenshtein value
  RSelenium, # remote browser
  tidyverse, # data manipulation
  lubridate, # datetime strings
  tidytext, # text analysis
  magrittr, # pipe opperators
  janitor, # dataframe clean
  refinr, # cluster and merge
  scales, # format strings
  knitr, # knit documents
  vroom, # read files fast
  glue, # combine strings
  here, # relative storage
  fs # search storage 
)
```

This document should be run as part of the `R_campfin` project, which lives as a sub-directory of
the more general, language-agnostic [`irworkshop/accountability_datacleaning`][01] GitHub
repository.

The `R_campfin` project uses the [RStudio projects][02] feature and should be run as such. The
project also uses the dynamic `here::here()` tool for file paths relative to _your_ machine.

```{r where_here, collapse=TRUE}
# where dfs this document knit?
here::here()
```

[01]: https://github.com/irworkshop/accountability_datacleaning "TAP repo"
[02]: https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects "Rproj"

## Data

Data is obtained by from the Nebraska Board of Examiners' [Open Data portal][03]. From this portal,
we will download the [Campaign Statements Data][04] from the Accountability and Disclosure 
Commission (NADC).

> A weekly export of the campaign filings based upon the paper records filed with the Nebraska
Accountability and Disclosure Commission.

[03]: http://www.nebraska.gov/government/open-data/
[04]: http://www.nebraska.gov/nadc_data/nadc_data.zip

## Import

The campaign finance data is provided as a series of text file organized in a relational database 
management system (DRMS).

### Download

The data is provided as a ZIP file, which can be downloaded locally.

```{r raw_dir}
raw_dir <- here("ne", "expends", "data", "raw")
dir_create(raw_dir)
```

```{r download_raw}
if (!all_files_new(raw_dir, "*.zip$")) {
  download.file(
    url = "http://www.nebraska.gov/nadc_data/nadc_data.zip",
    destfile = glue("{raw_dir}/nadc_data.zip")
  )
}
```

We can then unzip the file to the same `/raw` directory.

```{r unzip_raw}
if (!all_files_new(glue("{raw_dir}/nadc_data"), "*.txt$")) {
  unzip(
    zipfile = glue("{raw_dir}/nadc_data.zip"),
    exdir = raw_dir
  )
}
```

There are `r length(dir_ls(glue("{raw_dir}/nadc_data")))` files contained in the unzipped folder.

```{r list_raw, results='asis'}
raw_files <- dir_ls(glue("{raw_dir}/nadc_data"))
for (file in str_remove(raw_files, raw_dir)) {
    cat("*", file, "\n")
}
```

### Read

We can use `purrr::map()` to read each file with `readr::read_delim()` into a single list.

```{r map_read_raw}
ne_files <- 
  map(
    raw_files[2:62],
    read_delim,
    delim = "|",
    col_types = cols(.default = "c"),
    escape_backslash = FALSE,
    escape_double = FALSE
  ) %>% 
  map(clean_names) %>% 
  map(map_dfr, str_trim) %>% 
  set_names(value = tools::file_path_sans_ext(basename(names(.))))
```

## Explore

This list contains `r length(ne_files)` data frames, ranging from 
`r min(unlist(map(ne_files, nrow)))` rows to `r max(unlist(map(ne_files, nrow)))`. The contents and
structure of each data frame is described in the `/nadc_data/nadc_tables.rtf` text file.

From this file, we know the primary file of interest is named `/nadc_data/formb1d.txt`. This file
contains "Form B-1 Schedule D Section 1, Expenditures." The [NADC Form B-1][05] is used by
candidate and campaign committee's to report their financial transactions. Schedule D of that form
is used to report expenses, with Section 1 being finalized expenditures.

> List all payees who were paid more than $250 during this reporting period. If multiple payments
to the same payee totaled more than $250 throughout this reporting period, those expenditures must
be listed. Reporting period refers to your entry on Page 1 under Item 4. Expenditures to the same
payee over separate reporting periods should not be accumulated. Expenditures to the same payee
must be listed under the same name. If the committee reimburses the candidate or engages the
services of an advertising agency or another agent of the committee for expenses they incurred on
behalf of the committee, list the payments the committee made to the candidate or agent and also
list the payments which were made by the candidate or agent on behalf of the committee. (E.g., If
the candidate makes payments to a newspaper for advertising and is reimbursed by the committee,
report the payments made to the candidate but also list the payments made by the candidate to the
newspaper. Include the name of the newspaper, and the date of each of the expenditures by the
candidate and list the amount only in the “purpose” box along with the description of the
expenditure.)

[05]: http://www.nadc.nebraska.gov/docs/B-1-2018.doc

To better understand these expenditures, we can join this table with the other tables containing
information on the reporting committee and payee.

```{r join}
ne <- 
  left_join(
    x = ne_files$formb1d,
    y = select(ne_files$formb1, 1:18),
    by = c(
      "committee_id" = "committee_id_number",
      "date_received",
      "committee_name"
    )
  ) %>% 
  mutate(
    date_received = parse_date(date_received, "%m/%d/%Y"),
    expenditure_date = parse_date(expenditure_date, "%m/%d/%Y"),
    amount = parse_number(amount),
    in_kind = parse_number(in_kind),
    date_last_revised = parse_date(date_last_revised, "%m/%d/%Y"),
    postmark_date = parse_date(postmark_date, "%m/%d/%Y"),
    election_date = parse_date(election_date, "%m/%d/%Y"),
    report_start_date = parse_date(report_start_date, "%m/%d/%Y"),
    report_end_date = parse_date(report_end_date, "%m/%d/%Y")
  )
```

```{r glimpse}
head(ne)
tail(ne)
glimpse(sample_frac(ne))
```

### Missing

```{r count_na}
glimpse_fun(ne, count_na)
```

### Duplicates

```{r get_dupes}
ne_dupes <- distinct(get_dupes(ne))
```

```{r join_dupes}
ne <- ne %>% 
  left_join(ne_dupes) %>% 
  mutate(dupe_flag = !is.na(dupe_count)) %>% 
  select(-dupe_count)
```

### Categorical

### Continuous

## Wrangle

