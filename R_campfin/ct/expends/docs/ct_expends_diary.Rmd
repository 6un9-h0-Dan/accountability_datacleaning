---
title: "{State} {Data}"
author: "{First} {Last}"
date: "`r Sys.time()`"
output:
  github_document: 
    df_print: tibble
    toc: true
    toc_dept: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, purl=FALSE}
library(knitr)
opts_chunk$set(
  eval = FALSE,
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  comment = "#>",
  fig.path = "../plots/",
  fig.width = 10,
  dpi = 300
)
options(width = 99)
```

## Project

The Accountability Project is an effort to cut across data silos and give journalists, policy
professionals, activists, and the public at large a simple way to search across huge volumes of
public data about people and organizations.

Our goal is to standardizing public data on a few key fields by thinking of each dataset row as a
transaction. For each transaction there should be (at least) 3 variables:

1. All **parties** to a transaction
2. The **date** of the transaction
3. The **amount** of money involved

## Objectives

This document describes the process used to complete the following objectives:

1. How many records are in the database?
1. Check for duplicates
1. Check ranges
1. Is there anything blank or missing?
1. Check for consistency issues
1. Create a five-digit ZIP Code called `ZIP5`
1. Create a `YEAR` field from the transaction date
1. Make sure there is data on both parties to a transaction

## Packages

The following packages are needed to collect, manipulate, visualize, analyze, and communicate
these results. The `pacman` package will facilitate their installation and attachment.

```{r load_packages, message=FALSE, dfrning=FALSE, error=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  stringdist, # levenshtein value
  tidyverse, # data manipulation
  lubridate, # datetime strings
  magrittr, # pipe opperators
  janitor, # dataframe clean
  zipcode, # clean & database
  vroom, # read many files fast
  knitr, # knit documents
  glue, # combine strings
  here, # relative storage
  fs # search storage 
)
```

The IRW's `campfin` package will also have to be installed from GitHub. This package contains
functions custom made to help facilitate the processing of campaign finance data.

```{r load_campfin}
pacman::p_load_current_gh("kiernann/campfin")
```

This document should be run as part of the `R_campfin` project, which lives as a sub-directory of
the more general, language-agnostic [`irworkshop/accountability_datacleaning`][01] GitHub
repository.

The `R_campfin` project uses the [RStudio projects][02] feature and should be run as such. The
project also uses the dynamic `here::here()` tool for file paths relative to _your_ machine.

```{r where_here, collapse=TRUE}
# where dfs this document knit?
here::here()
```

[01]: https://github.com/irworkshop/accountability_datacleaning "TAP repo"
[02]: https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects "Rproj"

## Data

Data is provided by the [Connecticut State Elections Enforcment Commission (SEEC)][03]. The data
is processed through the [SEEC Campaign Reporting Information System (eCRIS)][04].

[03]: https://portal.ct.gov/seec "seec"
[04]: https://seec.ct.gov/eCrisHome/ "ecris"

### About

On the [eCRIS search page][05], SEEC provides an explanation on that can be found:

> This page allows the public to search, browse and download information from campaign finance
reports filed by committees with the SEEC’s Disclosure and Audit Unit. The term committees for
purposes of this summary includes: Candidate committees, Exploratory committees, Party committees
and Political Action committees (also known as PACs). We shall refer to all four distinct committee
types as political committees in order to accent the political nature of their purpose in
relationship to the financing of election campaigns for elective public office in Connecticut. The
Commission strives to offer fast and easy public access to the filings by committees.
> 
> In most instances the Commission staff is able to make these documents and information accessible
for the public to search and view in a matter of hours.
>
> In pursuit of SEEC’s mission to make information specific to political activities accessible in a
user friendly manner to the public, we offer five distinct search options. Each option has been
carefully designed to cater to the needs of its specific public audience. Our audience may include
citizens generally interested in the democracy, researchers, reporters, students, politicians,
political campaign staff, legislators, lobbyists and many others.

From that page, we can go the [bulk downloads page][06], where four links are organized by year:

* Disbursements Data for Party and PAC Committees
* Receipts Data for Party and PAC Committees 
* Disbursements Data for Candidate and Exploratory Committees 
* Receipts Data for Candidate and Exploratory Committees 

Data is available from 1999 to 2019.

[05]: https://seec.ct.gov/eCrisHome/eCRIS_Search/eCrisSearchHome "about"
[06]: https://seec.ct.gov/eCrisHome/eCRIS_Search/PreviousYears.aspx "bulk"

## Import

Anual files can be downloaded as CSV from this page. We only want the "disbursment" files.

> Disbursements Data for Party, Political, Candidate and Exploratory Committees (e-filed in eCRIS
and paper report transactions were entered by the State Election Enforcement Comission staff using
a data entry module.)

### Download

To download **immutable** raw data files, we first need to create the download URLs for both
PAC and Candidate expenditures.

```{r download_raw}
base_urls <- "http://seec.ct.gov/ecrisreporting/Data/eCrisDownloads/exportdatafiles"
pac_url <- glue("{base_url}/Disbursements{2008:2019}CalendarYearPartyPACCommittees.csv")
can_url <- glue("{base_url}/Disbursements{2008:2019}ElectionYearCandidateExploratoryCommittees.csv")
ct_urls <- c(pac_url, can_url)
```

```{r download_raw}
raw_dir <- here("ct", "expends", "data", "raw")
dir_create(raw_dir)

if (!all_files_new(raw_dir)) {
  for (url in ct_urls) {
    tryCatch(
      error = function(e) print("No file"),
      download.file(
        url = url,
        destfile = glue("{raw_dir}/{basename(url)}")
      )
    )
  }
}
```

```{r read_raw}
ct_files <- dir_ls(raw_dir, glob = "*.csv")

ct <- map(
  ct_files,
  read_csv,
  na = c("", "NA", "NULL"),
  col_types = cols(.default = "c")
)

ct <- ct %>% 
  bind_rows() %>% 
  clean_names() %>% 
  mutate_all(str_to_upper) %>% 
  na_if("VOID") %>% 
  mutate(
    payment_date = parse_date(payment_date, "%m/%d/%Y"),
    amount = parse_number(amount),
    file_to_state = parse_date(file_to_state, "%m/%d/%Y"),
    period_start = parse_date(period_start, "%m/%d/%Y"),
    period_end = parse_date(period_end, "%m/%d/%Y"),
    election_year = parse_integer(election_year),
    refiled_electronically = parse_date(refiled_electronically, "%m/%d/%Y"),
  )
```

