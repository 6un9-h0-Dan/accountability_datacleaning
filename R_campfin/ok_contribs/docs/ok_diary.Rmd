---
title: "Data Diary"
subtitle: "Nevada Contributions"
author: "Kiernan Nicholls"
date: "`r format(Sys.time())`"
output:
  html_document: 
    df_print: tibble
    fig_caption: yes
    highlight: tango
    keep_md: yes
    max.print: 32
    toc: yes
    toc_float: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, purl=FALSE}
library(knitr)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  comment = "#>",
  fig.path = "../plots/",
  fig.width = 10,
  dpi = 300
)
options(width = 99)
```

## Objectives

1. How many records are in the database?
1. Check for duplicates
1. Check ranges
1. Is there anything blank or missing?
1. Check for consistency issues
1. Create a five-digit ZIP Code called ZIP5
1. Create a YEAR field from the transaction date
1. For campaign donation data, make sure there is both a donor AND recipient

## Packages

The following packages are needed to collect, manipulate, visualize, analyze, and communicate
these results. The `pacman` package will facilitate their installation and attachment.

```{r p_load, message=FALSE, warning=FALSE, error=FALSE}
# install.packages("pacman")
pacman::p_load(
  tidyverse, # data manipulation
  lubridate, # date strings
  magrittr, # pipe opperators
  janitor, # data cleaning
  refinr, # cluster and merge
  rvest, # scrape web pages
  knitr, # knit documents
  here, # navigate local storage
  fs # search local storage 
)
```

```{r conflicts, echo=FALSE}
here <- here::here
```

## Data

If the raw data has not been downloaded, it can be retrieved from the 
[Oklahoma Ethics Commision's website](https://www.ok.gov/ethics/public/login.php) as a ZIP archive.

> Everyone has access to the public disclosure system, the only secured access point is the
downloadable raw data option. This option provides an entire database dump in comma separated value
(.csv) or tab delimited (.txt) formats. This secure area is intended for use by the media and
import into an existing database.

```{r any_old_files, echo=FALSE}
any_old_files <- function(path, type) {
  path %>%
    dir_ls(type = "file", glob = type) %>% 
    file_info() %>% 
    pull(modification_time) %>% 
    as.Date() %>% 
    equals(today()) %>% 
    not() %>% 
    any()
}
```

```{r download_zip}
if (here("ok_contribs", "data", "raw") %>% any_old_files("*.zip")) {
  download.file(
    url = "https://www.ok.gov/ethics/public/dfile.php?action=csv",
    destfile = here("ok_contribs", "data", "raw", "ethicscsvfile.zip")
  )
}
```

There are 48 individual CSV files contained within the ZIP archive. Many of these files are not
relevant to this project, but all will be unzipped into the `data/raw` directory.

```{r unzip_list, echo=FALSE}
unzip(
  zipfile = here("ok_contribs", "data", "raw", "ethicscsvfile.zip"),
  list = TRUE
)
```

If these files have not yet been unzipped, they will be now.

```{r unzip}
if (here("ok_contribs", "data", "raw") %>% any_old_files("*.zip")) {
  unzip(
    zipfile = here("ok_contribs", "data", "raw", "ethicscsvfile.zip"),
    exdir = here("ok_contribs", "data", "raw")
  )
}
```

## Read

The data of interest is spread across a number of different files than can be joined along their
respective `*_id` variables. The `transaction.csv` contains the list of contributions and expenses,
and data on those transactions is spread across other tables. 

The relationship between these files is described in the `data/relations_db.xls` Excel file.
Descriptions for each of these files is provided int the `data/descriptions.doc` Word file.

In general, there are three _types_ of files that need to be read and joined together

1. All transactions
  * `transaction.csv`
1. Contributor information
  * `contributor.csv`
    * `cont_type.csv`
  * `individual_cont.csv`
  * `business_cont.csv`
  * `committee_cont.csv`
  * `vendor_cont.csv`
1. Recipient information
  * `so1.csv`
  * `so2.csv`
  * `party.csv`
  * `district.csv`
  * `office.csv`
  * `affiliation.csv`
  * `report.csv`
  * `lump_fund.csv`
  * `surplus.csv`
  * `refund.csv`

They will each be read as data frames using `readr::read_csv()`. All files contain an erronous
trailing column in the header resulting in an empty column that will be removed. All variable names
will be made "clean" (lowercase and snake_case) using `janitor::clean_names()`.

### Transactions

> Holds all the contribution and expenditure transactions. Has the transaction date, amount, the contributor id and report number (report_num) that it ties back to in the report table.

```{r read_transaction}
transactions <- read_csv(
  file = "ok_contribs/data/raw/transaction.csv",
  col_types = cols(
    TRANS_INDEX = col_character(),
    TRANSACTION_DATE = col_date("%d-%b-%y"),
    CONTRIBUTOR_ID = col_character(),
    TRANS_AMOUNT = col_double(),
    REP_NUM = col_character()
  )
)

transactions <- transactions %>% 
  select(-X6) %>% 
  clean_names() %>% 
  rename(cont_id = contributor_id)

print(transactions)
```

### Contributors

> Holds address, phone and type of any contributor using [`contributor_id`] as its identifier in
other tables.

```{r read_contributor}
contributors <- read_csv(
  file = "ok_contribs/data/raw/contributor.csv",
  col_types = cols(.default = col_character())
)

contributors <- contributors %>%
  select(-X9, -PHONE, -EXT) %>% 
  clean_names() %>% 
  rename(
    cont_id = contributor_id,
    cont_type = type,
    cont_street = street,
    cont_city = city,
    cont_state = state,
    cont_zip = zip
  )

print(contributors)
```

> Holds the different contributor types available (Individual, Business, Committee, Vendor)

```{r read_cont_type}
cont_types <- read_csv(
  file = "ok_contribs/data/raw/cont_type.csv",
  col_types = cols(.default = col_character())
)

cont_types <- cont_types %>%
  select(-X3) %>% 
  clean_names()

print(cont_types)
```

#### Individual Contributors

> Holds information relating to any individual contributor. Name, employer and occupation. Contributor id is the key that goes back to the contributor table and into either the transaction table for a transaction list or contributor aggregate table for tie ins to the `ethics_num` (committee) with aggregate totals.

```{r read_individual_cont}
individual_conts <- read_csv(
  file = "ok_contribs/data/raw/individual_cont.csv",
  col_types = cols(.default = col_character())
)

individual_conts <- individual_conts %>% 
  select(-X7) %>% 
  clean_names() %>% 
  rename(
    cont_id = contributor_id,
    cont_employer = employer,
    cont_occupation = occupation
  )
```

#### Business Contributors

> Holds the business name (`cont_name`) and business activity of a business contributor.
Contributor id is the key that goes back to the contributor table and into either the transaction
table for a transaction list or contributor aggregate table for tie ins to the `ethics_num`
(committee) with aggregate totals.

```{r read_business_cont}
business_conts <- read_csv(
  file = "ok_contribs/data/raw/business_cont.csv",
  col_types = cols(.default = col_character())
)

business_conts <- business_conts %>% 
  select(-X4) %>% 
  clean_names() %>% 
  rename(
    cont_bname = cont_name,
    cont_activity = business_activity
    )
```

#### Committee Contributors

> Holds the principal interest, contributor committee name and contributor FEC number and
committees ethics number for any committee contributors (`contributor_id`). Contributor id is the
key that goes back to the contributor table and into either the transaction table for a transaction
list or contributor aggregate table for tie ins to the ethics_num (committee) with aggregate
totals.

```{r read_committee_cont}
committee_conts <- read_csv(
  file = "ok_contribs/data/raw/committee_cont.csv",
  col_types = cols(.default = col_character())
)

committee_conts <- committee_conts %>% 
  select(-X6) %>% 
  clean_names() %>% 
  rename(
    cont_id = id,
    ethics_id = ethics_num,
    cont_cname = committee_name
  )
```

#### Vendor Contributors

> Holds the Vendor Contributor name for any expenditure transaction

```{r read_vendor_cont}
vendor_conts <- read_csv(
  file = "ok_contribs/data/raw/vendor_cont.csv",
  col_types = cols(.default = col_character())
)

vendor_conts <- vendor_conts %>% 
  select(-X3) %>% 
  clean_names() %>% 
  rename(
    cont_interest = principal_interest,
    cont_vname = cont_name
  )
```

### Recipients

### Statment of Organization

The "SO-1" form applies to committees formed to support a political candidate.

```{r read_so1}
so1 <- read_csv(
  file = "ok_contribs/data/raw/so1.csv",
  col_types = cols(
    .default = col_character(),
    STRICKEN_WITHDRAWN = col_logical(),
    ORGANIZATION_DATE = col_date("%m/%d/%Y")
    )
  )

so1 <- so1 %>% 
  select(-X27) %>% 
  clean_names() %>% 
  rename(ethics_id = ethics_num)

# fix logical parse
so1$special_election <- 
  so1$special_election %>% 
  str_replace("yes", "1") %>% 
  str_replace("no", "0") %>% 
  parse_logical()
```

The "SO-2" form applies to committees formed to support non-candidate issues.

```{r read_so2}
so2 <- read_csv(
  file = "ok_contribs/data/raw/so2.csv",
  col_types = cols(
    .default = col_character()
  )
)

so2 <- so2 %>% 
  select(-X15) %>% 
  clean_names() %>% 
  rename(ethics_id = ethics_num)

# fix logical parse
so2$stmnt_of_intent <- 
  so2$stmnt_of_intent %>%
  recode("y" = "1", "n" = "0") %>% 
  parse_logical()
```

#### Affiliation

> Contains the banking information for the SO1 or SO2 that is filed. The rep_num refers to the
appropriate SO1 or SO2 in the Report table. The name, address, street, city, state and zip for the
bank are contained in this table.

```{r}
affiliation <- read_csv(
  file = "ok_contribs/data/raw/affiliation.csv",
  col_types = cols(.default = col_character())
)

affiliation <- affiliation %>% 
  select(-X8) %>% 
  clean_names()
```

#### Ballot Measures

> Holds the ballot year for the appropriate SO1 or SO2 that is filed. The rep_num refers to the
appropriate SO1 or SO2 in the Report table.

```{r}
ballot_measure <- read_csv(
  file = "ok_contribs/data/raw/ballot_measure.csv",
  col_types = cols(.default = col_character())
)

ballot_measure <- ballot_measure %>% 
  select(-X3) %>% 
  clean_names()
```

#### Depository

> Holds the full name and address for the depository information for the SO1 or SO2 from the
report_num field that relates to the report table.

```{r}
depository <- read_csv(
  file = "ok_contribs/data/raw/depository.csv",
  col_types = cols(.default = col_character())
)

depository <- depository %>% 
  select(-X8) %>% 
  clean_names()
```

#### Parties

> Has the different party affiliation types

```{r read_party}
parties <- read_csv(
  file = "ok_contribs/data/raw/party.csv",
  col_types = cols(
    VIEWABLE = col_logical(),
    PARTY_ID = col_character(),
    PARTY_DESC = col_character()
  )
)

parties <- parties %>% 
  select(-X4) %>% 
  clean_names()
```

#### Offices

> Description of office types (mainly for elections)

```{r read_district}
office <- read_csv(
  file = "ok_contribs/data/raw/office.csv",
  col_types = cols(.default = col_character())
)

office <- office %>% 
  select(-X3) %>% 
  clean_names() %>% 
  rename(office_id = id)
```

#### Districts

> List of the districts for elections

```{r read_district}
district <- read_csv(
  file = "ok_contribs/data/raw/district.csv",
  col_types = cols(.default = col_character())
)

district <- district %>% 
  select(-X3) %>% 
  clean_names()
```

#### Candidates

> Holds the candidate name and birthdate tied to the specific ethics_num (committee)

```{r read_candidate}
candidates <- read_csv(
  file = "ok_contribs/data/raw/candidate.csv",
  col_types = cols(.default = col_character())
)

candidates <- candidates %>% 
  select(-X6, -BIRTHDATE) %>% 
  clean_names() %>% 
  rename(ethics_id = ethics_num)
```

#### Lump Funds

> Holds lump fund information for the respective report_num

```{r read_district}
lump_funds <- read_csv(
  file = "ok_contribs/data/raw/lump_fund.csv",
  col_types = cols(
    .default = col_character(),
    LUMP_AMOUNT = col_double(),
    LUMP_DATE = col_date("%d-%b-%y")
    )
)

lump_funds <- lump_funds %>% 
  select(-X8) %>% 
  clean_names()
```

### Report

> Holds all the `report_num` for all filed reports in the system from the SO1, SO2s to all the C1R,
C3R, C4R, and C5R reports. C6R reports are stored in the c6r_report table. Contains the date the
report was submitted, the `ethics_num` (committee) that it ties to, period id, the report type,
signature field, admin entered (means the report was filed by administrator), the amended reference
(if null, is the latest report, if not then that report was amended to the `report_num` that is
displayed in that field.), the final flag determines if that was the final report they will be
filing and `supp_year` is just a field on the form to show the year.

```{r read_report}
reports <- read_csv(
  file = "ok_contribs/data/raw/report.csv",
  col_types = cols(
    .default = col_character(),
    SUBMITTED_DATE = col_date("%d-%b-%y"),
    FINAL = col_logical()
  )
)

reports <- reports %>% 
  select(-X11) %>% 
  clean_names() %>% 
  rename(ethics_id = ethics_num)
```

> Description of each type of report available  (SO1, SO2, C1R, C3R, C4R, C5R, C6R)

```{r read_rep_type}
rep_types <- read_csv(
  file = "ok_contribs/data/raw/report_type.csv",
  col_types = cols(.default = col_character())
)

rep_types <- rep_types %>%
  select(-X3) %>% 
  clean_names()
```

## Join

### Contributors

First, we will join the `contributors` table, which contains geographic data on each contributor
(city, state, zip), which the full tables of each contributor type.

There are four types of contributors, each identified with different `cont_*name` variables:

1. Individuals with `cont_fname` (first), `cont_mname` (middle), and `cont_lname` (last)
    * With `cont_employer` and `cont_occupation`
1. Businesses with a `cont_bname`
    * With `cont_activity`
1. Committees with a `cont_cname`
    * with `cont_interest` and `ethics_id`
1. Vendors with a `cont_vname`
    * With OK Ethics Commission `ethics_id`

```{r join_conts, collapse=TRUE}
nrow(contributors)
nrow(individual_conts)
nrow(business_conts)
nrow(committee_conts)
nrow(vendor_conts)

contributors <- contributors %>% 
  left_join(individual_conts, by = "cont_id") %>% 
  left_join(business_conts, by = "cont_id") %>% 
  left_join(committee_conts, by = "cont_id") %>% 
  left_join(vendor_conts, by = "cont_id") %>% 
  left_join(cont_types, by = "cont_type")
```

There appears to be more total contributors than listed in the `contributors` database. There are
`r nrow(individual_conts) - nrow(contributors)` more _individual_ contributors alone than there are
total records in the `contributors` database.

```{r cont_miss, collapse=TRUE}
nrow(individual_conts) - nrow(contributors)
mean(individual_conts$cont_id %in% contributors$cont_id)
```

### Recipients

Contributions can be made to candidates and committees. These contributions are reported _by_ the
recipients in various report forms listed in the `reports` (and `rep_type`).

The filer of those reports is given an `ethics_id` by the Oklahoma Ethics Commision, which then
corrisponds to the `candidates` and `committees` databases.

```{r join_repts}
reports %>% 
  select(rep_num, ethics_id) %>% 
  left_join(candidates, by = "ethics_id")
```

### Transactions

Once we have this single table of contributor information, we can join it with the `transactions`
database to provide information on the contributing party to each transaction.

```{r join_trans}
ok <- transactions %>% 
  left_join(contributors, by = "cont_id")
```

